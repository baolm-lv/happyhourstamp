<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="initial-scale=1.0, maximum-scale=2.0">
	<title>Service Management</title>
	<link rel="stylesheet" href="/lib/bootstrap/3.3.6/css/bootstrap.min.css">
	<link rel="stylesheet" href="/lib/datatables/1.10.12/css/dataTables.bootstrap.min.css">
	<script src="/lib/jquery/1.12.0/jquery.min.js"></script>
	<script src="/lib/datatables/1.10.12/js/jquery.dataTables.min.js"></script>
	<script src="/lib/datatables/1.10.12/js/dataTables.bootstrap.min.js"></script>
	<style>
		.btn {margin: 0 5px}
	</style>
</head>
<body>
	<nav class="navbar navbar-inverse">
		<div class="container">
			<div class="navbar-header">
				<a class="navbar-brand" href="">HHS-Service</a>
			</div>
			<div id="navbar" class="collapse navbar-collapse">
				<ul class="nav navbar-nav">
					<li class="active"><a href="services.html">服务管理</a></li>
					<li class=""><a href="eureka.html">Eureka</a></li>
					<li class=""><a href="metrics.html">Metrics</a></li>
				</ul>
			</div>
		</div>
	</nav>
	<div class="container mt10">
		<table id="serviceTable" class="table table-striped table-bordered" cellspacing="0" width="100%">
	        <thead>
	        	<tr>
	        		<th colspan="4">
		        		<button class="btn btn-primary resumeAll">清除所有降级</button>
	        		</th>
	        	</tr>
	            <tr>
	                <th>Paths</th>
	                <th>Methods</th>
	                <th>Status</th>
	                <th>Operations</th>
	            </tr>
	        </thead>
	    </table>
	</div>
</body>
<script type="text/javascript">
function format ( d ) {
    return '<table cellpadding="5" class="table" cellspacing="0" border="0" style="padding-left:50px;">'+
		'<tr>'+
			'<td>Produces:</td>'+
			'<td>'+d.produces+'</td>'+
		'</tr>'+
		'<tr>'+
			'<td>Consumes:</td>'+
			'<td>'+d.consumes+'</td>'+
		'</tr>'+
		'<tr>'+
			'<td>Bean:</td>'+
			'<td>'+d.beanName+'</td>'+
		'</tr>'+
		'<tr>'+
			'<td>Method:</td>'+
			'<td>'+d.methodName+'</td>'+
		'</tr>'+
	'</table>';
}
function operationCell() {
	return '<button type="button" class="btn btn-success downGrade">降级</button>'+
		'<button type="button" class="btn btn-success recover">恢复</button>';
} 
$(document).ready(function() {
    var table = $('#serviceTable').DataTable( {
        "ajax": "/mgt/service?_=" + new Date().getTime(),
        "columns": [
            { "data": "paths" },
            { "data": "methods" },
            { "data": function(row){ return row.disabled == "Y" ? "停用" : "有效";} },
            { "data": null , "defaultContent": operationCell()}
        ],
        "createdRow": function( row, data, dataIndex ) {
            if ( data.disabled == "Y" ) {
            	$(row).addClass( 'danger' );
            	$(row).find("button.downGrade").addClass("disabled");
        	} else {
        		$(row).find("button.recover").addClass("disabled");
        	}
        }
    } );
    
    table.order([2, 'asc']).draw();
    
    $('#serviceTable tbody').on('click', 'tr', function () {
    	if(!$(this).attr("role")) 
    		return;
        var row = table.row( this );
        if ( row.child.isShown() ) {
            row.child.hide();
        } else {
            row.child( format(row.data()) ).show();
        }
    } );
    $('#serviceTable tbody').on('click', 'button.recover', function(event) {
    	if($(this).hasClass("disabled"))
    		return ;
    	var tr = $(this).closest('tr');
    	var row = table.row( tr );
    	var methods = row.data().methods;
    	if(!methods) 
    		return ;

    	var request = {};
    	request.ids = [];
    	request.ids.push(row.data().id);
    	
    	$.ajax({
			url : "/mgt/service/recover",
			contentType : "application/json",
			type : "post",
			data : JSON.stringify(request)
		}).done(function(){
			$(tr).removeClass( 'danger' );
			$(tr).find("button.downGrade").removeClass("disabled");
			$(tr).find("button.recover").addClass("disabled");
		}).fail(function(){
			alert("操作失败");
		});
    	
    	event.stopPropagation();
    });
    $('#serviceTable tbody').on('click', 'button.downGrade', function(event) {
    	if($(this).hasClass("disabled"))
    		return ;
    	var tr = $(this).closest('tr');
    	var row = table.row( tr );
    	var paths = row.data().paths;
    	var methods = row.data().methods;
    	if(!methods) 
    		return ;
    	
    	var request = {};
    	request.methods = [];
    	if(row.data().id) {
			request.ids = [];
			request.ids.push(row.data().id);
    	} else {
			request.methods.push(paths[0] + "_" + methods[0]);
    	}
    	
    	$.ajax({
			url : "/mgt/service/downgrade",
			contentType : "application/json",
			type : "post",
			data : JSON.stringify(request)
		}).done(function(){
			$(tr).addClass( 'danger' );
			$(tr).find("button.downGrade").addClass("disabled");
			$(tr).find("button.recover").removeClass("disabled");
		}).fail(function(){
			alert("操作失败");
		});
    	
    	event.stopPropagation();
    });
    
    $("#serviceTable").on("click", "button.resumeAll", function(event){
    	$.ajax({
			url : "/mgt/service/recover-all",
			contentType : "application/json",
			type : "post"
		}).done(function(){
			$("#serviceTable").find(".danger").removeClass("danger");
		}).fail(function(){
			alert("操作失败");
		});
    });
    
} );
</script>
</html>